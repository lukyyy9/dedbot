{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>‚öñÔ∏è Gestion des Poids</h2>
    
    <p style="color: #8b949e; margin-bottom: 20px;">
        Les poids d√©terminent l'importance de chaque formule dans le score final. 
        La somme doit √™tre √©gale √† 1.0.
    </p>
    
    {% if not formulas %}
    <div style="background: #382d1a; border: 1px solid #854d0e; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
        <p style="margin: 0; color: #fbbf24;">
            ‚ö†Ô∏è Aucune formule n'est d√©finie. Veuillez d'abord cr√©er des formules dans la page 
            <a href="{{ url_for('formulas_page') }}" style="color: #58a6ff;">Formules</a>.
        </p>
    </div>
    {% else %}
    <form method="POST">
        <table style="margin-bottom: 20px;">
            <thead>
                <tr>
                    <th>Formule</th>
                    <th>Description</th>
                    <th style="width: 150px;">Poids</th>
                </tr>
            </thead>
            <tbody>
                {% for name, data in formulas.items() %}
                <tr>
                    <td><code>{{ name }}</code></td>
                    <td style="color: #8b949e; font-size: 0.9em;">
                        {{ data.description or data.formula[:50] + '...' if data.formula|length > 50 else data.formula }}
                    </td>
                    <td>
                        <input type="number" name="weight_{{ name }}" 
                               step="0.01" min="0" max="1" 
                               value="{{ data.weight }}"
                               style="width: 100%;">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="stat" style="margin: 20px 0;">
            <div class="stat-value" id="total-weight">{{ total|round(2) }}</div>
            <div class="stat-label">Total (doit √™tre = 1.0)</div>
        </div>
        
        <button type="submit" class="btn">üíæ Sauvegarder les poids</button>
        <button type="button" class="btn btn-secondary" onclick="normalizeWeights()">
            üîß Normaliser automatiquement
        </button>
    </form>
    {% endif %}
</div>

<script>
// Calculer le total en temps r√©el
function updateTotal() {
    let total = 0;
    const inputs = document.querySelectorAll('input[name^="weight_"]');
    inputs.forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    document.getElementById('total-weight').textContent = total.toFixed(2);
    
    // Colorer en rouge si diff√©rent de 1.0
    if (Math.abs(total - 1.0) > 0.01) {
        document.getElementById('total-weight').style.color = '#f85149';
    } else {
        document.getElementById('total-weight').style.color = '#3fb950';
    }
}

// Normaliser les poids pour que la somme fasse 1.0
function normalizeWeights() {
    const inputs = document.querySelectorAll('input[name^="weight_"]');
    let total = 0;
    
    inputs.forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    
    if (total > 0) {
        inputs.forEach(input => {
            const currentValue = parseFloat(input.value) || 0;
            input.value = (currentValue / total).toFixed(4);
        });
        updateTotal();
    }
}

// Attacher l'√©v√©nement de mise √† jour
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input[name^="weight_"]');
    inputs.forEach(input => {
        input.addEventListener('input', updateTotal);
    });
    updateTotal();
});
</script>
{% endblock %}
